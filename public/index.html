<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Mapping & Logs Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #d0d0d0;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .mapping-table th,
        .mapping-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .mapping-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 30px;
        }
        
        .mapping-table th:hover {
            background: #e9ecef;
        }
        
        .mapping-table th.sortable::after {
            content: ' ↕';
            position: absolute;
            right: 10px;
            opacity: 0.5;
            font-size: 12px;
        }
        
        .mapping-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }
        
        .mapping-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }
        
        .mapping-table tr:hover {
            background: #f8f9fa;
        }
        
        .key-cell {
            font-weight: 500;
            color: #2c3e50;
            max-width: 400px;
            word-break: break-word;
        }
        
        .value-cell {
            color: #555;
            max-width: 500px;
            word-break: break-word;
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .log-line {
            margin-bottom: 2px;
        }
        
        .log-line[data-level="ERROR"] {
            color: #f48771;
        }
        
        .log-line[data-level="WARN"] {
            color: #dcdcaa;
        }
        
        .log-line[data-level="INFO"] {
            color: #4ec9b0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Mapping & Logs Manager</h1>
            <div class="subtitle">Manage stock mappings and view application logs</div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('mapping')">Stock Mapping</button>
            <button class="tab" onclick="switchTab('operations')">Job Operations</button>
            <button class="tab" onclick="switchTab('section-operations')">Section Operations</button>
            <button class="tab" onclick="switchTab('folders')">Folders</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
            <button class="tab" onclick="switchTab('logs')">Logs</button>
        </div>
        
        <div id="mapping-tab" class="tab-content active">
            <div id="mapping-alert"></div>
            
            <div class="form-group">
                <label for="new-key">Stock Key (from email):</label>
                <input type="text" id="new-key" placeholder="e.g., 200gsm Synthetic">
            </div>
            
            <div class="form-group">
                <label for="new-value">Stock Code (for PrintIQ):</label>
                <div style="position: relative;">
                    <input type="text" id="new-value" placeholder="Type to search stock codes..." autocomplete="off" style="width: calc(100% - 120px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterStockDropdown(this.value)">
                    <div id="stock-dropdown" style="position: absolute; top: 100%; left: 0; right: 120px; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    <button class="btn btn-success" onclick="refreshStockDefinitions()" style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 4px 4px 0; padding: 0 15px;">Refresh Stock</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="new-process-front">Process Front:</label>
                <div style="position: relative;">
                    <input type="text" id="new-process-front" placeholder="Type to search processes..." autocomplete="off" style="width: calc(100% - 120px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterProcessDropdown('front', this.value)">
                    <button class="btn btn-success" onclick="refreshProcessTypes()" style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 4px 4px 0; padding: 0 15px;">Refresh Processes</button>
                    <div id="process-front-dropdown" style="position: absolute; top: 100%; left: 0; right: 120px; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="new-process-reverse">Process Reverse:</label>
                <div style="position: relative;">
                    <input type="text" id="new-process-reverse" placeholder="Type to search processes..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterProcessDropdown('reverse', this.value)">
                    <div id="process-reverse-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addMapping()">Add Mapping</button>
            
            <div style="margin-top: 30px; margin-bottom: 15px;">
                <label for="mapping-search" style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Search Mappings:</label>
                <input type="text" id="mapping-search" placeholder="Search by stock key, stock code, or process..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterMappings(this.value)">
                <div id="mapping-search-results" style="margin-top: 5px; font-size: 12px; color: #666; display: none;"></div>
            </div>
            
            <div id="mapping-table-container"></div>
        </div>
        
        <div id="operations-tab" class="tab-content">
            <div id="operations-alert"></div>

            <div class="form-group">
                <label for="new-operation">Operation Name:</label>
                <input type="text" id="new-operation" placeholder="e.g., Preflight">
            </div>

            <button class="btn btn-primary" onclick="addOperation()">Add Operation</button>
            <button class="btn btn-success" onclick="loadOperations()" style="margin-left: 10px;">Refresh</button>

            <div id="operations-table-container"></div>
        </div>

        <div id="section-operations-tab" class="tab-content">
            <div id="section-operations-alert"></div>

            <div class="form-group">
                <label for="new-section-operation">Section Operation Name:</label>
                <input type="text" id="new-section-operation" placeholder="e.g., Square Cut">
            </div>

            <div class="form-group">
                <label for="new-section-group">Group (optional):</label>
                <input type="text" id="new-section-group" placeholder="e.g., Die cut to shape">
            </div>

            <div class="form-group">
                <label for="new-section-rule">Rule (optional):</label>
                <input type="text" id="new-section-rule" placeholder="e.g., die cut (only include if this text appears in PRINT field)">
            </div>

            <button class="btn btn-primary" onclick="addSectionOperation()">Add Section Operation</button>
            <button class="btn btn-success" onclick="loadSectionOperations()" style="margin-left: 10px;">Refresh</button>

            <div id="section-operations-table-container"></div>
        </div>

        <div id="folders-tab" class="tab-content">
            <div id="folders-alert"></div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Select Email Folder</h3>
                <p style="color: #666; margin-bottom: 15px;">Choose the folder from which emails will be processed.</p>
                <div id="selected-folder-info" style="padding: 10px; background: #e8f4f8; border-radius: 4px; margin-bottom: 15px;">
                    <strong>Currently selected:</strong> <span id="current-folder-name">Loading...</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="loadFolders()">Refresh Folders</button>
            <button class="btn btn-success" onclick="loadFolderConfig()" style="margin-left: 10px;">Load Current Selection</button>

            <div id="folders-table-container" style="margin-top: 20px;"></div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div id="settings-alert"></div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Default Settings</h3>
                <p style="color: #666; margin-bottom: 15px;">Configure default stock and process values used when no specific mapping is found in emails.</p>
            </div>

            <div class="form-group">
                <label for="default-stock-code">Default Stock Code:</label>
                <div style="position: relative;">
                    <input type="text" id="default-stock-code" placeholder="Select default stock code..." autocomplete="off" style="width: calc(100% - 120px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterDefaultStockDropdown(this.value)">
                    <div id="default-stock-dropdown" style="position: absolute; top: 100%; left: 0; right: 120px; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    <button class="btn btn-success" onclick="refreshDefaultStockDefinitions()" style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 4px 4px 0; padding: 0 15px;">Refresh Stock</button>
                </div>
            </div>

            <div class="form-group">
                <label for="default-process-front">Default Process Front:</label>
                <div style="position: relative;">
                    <input type="text" id="default-process-front" placeholder="Select default front process..." autocomplete="off" style="width: calc(100% - 120px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterDefaultProcessDropdown('front', this.value)">
                    <button class="btn btn-success" onclick="refreshDefaultProcessTypes()" style="position: absolute; right: 0; top: 0; height: 100%; border-radius: 0 4px 4px 0; padding: 0 15px;">Refresh Processes</button>
                    <div id="default-process-front-dropdown" style="position: absolute; top: 100%; left: 0; right: 120px; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="default-process-reverse">Default Process Reverse:</label>
                <div style="position: relative;">
                    <input type="text" id="default-process-reverse" placeholder="Select default reverse process..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterDefaultProcessDropdown('reverse', this.value)">
                    <div id="default-process-reverse-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            <button class="btn btn-success" onclick="loadSettings()" style="margin-left: 10px;">Load Current Settings</button>
        </div>

        <div id="logs-tab" class="tab-content">
            <div class="log-controls">
                <button class="btn btn-primary" onclick="loadLatestLogs()">Refresh Logs</button>
                <label style="margin-left: 20px;">
                    Lines to show:
                    <input type="number" id="log-lines" value="100" min="10" max="1000" style="width: 80px; padding: 5px; margin-left: 5px;">
                </label>
            </div>
            <div id="log-viewer" class="log-viewer">
                <div class="loading">Loading logs...</div>
            </div>
        </div>
    </div>
    
    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'mapping') {
                loadMappings();
                loadProcessTypesForDropdowns();
            } else if (tabName === 'operations') {
                loadOperations();
            } else if (tabName === 'section-operations') {
                loadSectionOperations();
            } else if (tabName === 'folders') {
                loadFolders();
                loadFolderConfig();
            } else if (tabName === 'settings') {
                loadSettings();
                loadDefaultStockDefinitions();
                loadDefaultProcessTypesForDropdowns();
            } else if (tabName === 'logs') {
                loadLatestLogs();
            }
        }
        
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Store full mapping data for filtering
        let allMappings = {};
        let stockDefinitionsMap = {}; // Map stock code to description
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        async function loadMappings() {
            try {
                // Load stock definitions for descriptions
                try {
                    const stockResponse = await fetch('/api/printiq-stock-definitions');
                    const stockDefinitions = await stockResponse.json();
                    stockDefinitionsMap = {};
                    stockDefinitions.forEach(stock => {
                        if (stock.code) {
                            stockDefinitionsMap[stock.code] = stock.description || '';
                        }
                    });
                } catch (err) {
                    console.warn('Failed to load stock definitions:', err);
                }
                
                const response = await fetch('/api/stock-mapping');
                allMappings = await response.json();
                
                // Check if there's an active search term and reapply filter
                const searchInput = document.getElementById('mapping-search');
                if (searchInput && searchInput.value.trim() !== '') {
                    filterMappings(searchInput.value);
                } else {
                    displayMappings(allMappings);
                }

                // Load process types for dropdowns
                await loadProcessTypesForDropdowns();
            } catch (error) {
                showAlert('mapping-alert', 'Error loading mappings: ' + error.message, 'error');
            }
        }
        
        function filterMappings(searchTerm) {
            const resultsDiv = document.getElementById('mapping-search-results');
            const totalCount = Object.keys(allMappings).length;
            
            if (!searchTerm || searchTerm.trim() === '') {
                displayMappings(allMappings);
                resultsDiv.style.display = 'none';
                return;
            }
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = {};
            
            Object.keys(allMappings).forEach(key => {
                const mappingData = allMappings[key];
                // Support both old format (string) and new format (object)
                const value = typeof mappingData === 'string' ? mappingData : (mappingData.value || '');
                const processFront = typeof mappingData === 'object' ? (mappingData.processFront || '') : '';
                const processReverse = typeof mappingData === 'object' ? (mappingData.processReverse || '') : '';
                
                // Search in key, value, processFront, and processReverse
                if (key.toLowerCase().includes(searchLower) ||
                    value.toLowerCase().includes(searchLower) ||
                    processFront.toLowerCase().includes(searchLower) ||
                    processReverse.toLowerCase().includes(searchLower)) {
                    filtered[key] = mappingData;
                }
            });
            
            const filteredCount = Object.keys(filtered).length;
            resultsDiv.textContent = `Showing ${filteredCount} of ${totalCount} mapping${totalCount !== 1 ? 's' : ''}`;
            resultsDiv.style.display = 'block';
            
            // Apply sorting if active
            if (currentSortColumn) {
                const sorted = sortMappings(filtered, currentSortColumn, currentSortDirection);
                displayMappings(sorted);
            } else {
                displayMappings(filtered);
            }
        }
        
        function sortMappings(mapping, sortColumn, direction) {
            const keys = Object.keys(mapping);
            const sortedKeys = [...keys].sort((a, b) => {
                const mappingDataA = mapping[a];
                const mappingDataB = mapping[b];
                
                let valueA, valueB;
                
                switch(sortColumn) {
                    case 'key':
                        valueA = a.toLowerCase();
                        valueB = b.toLowerCase();
                        break;
                    case 'code':
                        valueA = (typeof mappingDataA === 'string' ? mappingDataA : (mappingDataA.value || '')).toLowerCase();
                        valueB = (typeof mappingDataB === 'string' ? mappingDataB : (mappingDataB.value || '')).toLowerCase();
                        break;
                    case 'description':
                        const codeA = typeof mappingDataA === 'string' ? mappingDataA : (mappingDataA.value || '');
                        const codeB = typeof mappingDataB === 'string' ? mappingDataB : (mappingDataB.value || '');
                        valueA = (stockDefinitionsMap[codeA] || '').toLowerCase();
                        valueB = (stockDefinitionsMap[codeB] || '').toLowerCase();
                        break;
                    case 'processFront':
                        valueA = (typeof mappingDataA === 'object' ? (mappingDataA.processFront || '') : '').toLowerCase();
                        valueB = (typeof mappingDataB === 'object' ? (mappingDataB.processFront || '') : '').toLowerCase();
                        break;
                    case 'processReverse':
                        valueA = (typeof mappingDataA === 'object' ? (mappingDataA.processReverse || '') : '').toLowerCase();
                        valueB = (typeof mappingDataB === 'object' ? (mappingDataB.processReverse || '') : '').toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            const sortedMapping = {};
            sortedKeys.forEach(key => {
                sortedMapping[key] = mapping[key];
            });
            
            return sortedMapping;
        }
        
        function handleSort(column) {
            if (currentSortColumn === column) {
                // Toggle direction if clicking same column
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Get current filtered mappings or all mappings
            const searchInput = document.getElementById('mapping-search');
            const searchTerm = searchInput && searchInput.value.trim() !== '' ? searchInput.value : '';
            const mappingsToSort = searchTerm ? 
                Object.keys(allMappings).filter(key => {
                    const mappingData = allMappings[key];
                    const value = typeof mappingData === 'string' ? mappingData : (mappingData.value || '');
                    const processFront = typeof mappingData === 'object' ? (mappingData.processFront || '') : '';
                    const processReverse = typeof mappingData === 'object' ? (mappingData.processReverse || '') : '';
                    const searchLower = searchTerm.toLowerCase();
                    return key.toLowerCase().includes(searchLower) ||
                           value.toLowerCase().includes(searchLower) ||
                           processFront.toLowerCase().includes(searchLower) ||
                           processReverse.toLowerCase().includes(searchLower);
                }).reduce((acc, key) => { acc[key] = allMappings[key]; return acc; }, {}) :
                allMappings;
            
            const sorted = sortMappings(mappingsToSort, currentSortColumn, currentSortDirection);
            displayMappings(sorted);
        }
        
        function displayMappings(mapping) {
            const container = document.getElementById('mapping-table-container');
            const keys = Object.keys(mapping);
            
            if (keys.length === 0) {
                const searchInput = document.getElementById('mapping-search');
                const hasSearchTerm = searchInput && searchInput.value.trim() !== '';
                container.innerHTML = `<div class="empty-state">${hasSearchTerm ? 'No mappings found matching your search.' : 'No stock mappings found. Add one above to get started.'}</div>`;
                return;
            }
            
            // Determine sort classes for headers
            const getSortClass = (column) => {
                if (currentSortColumn === column) {
                    return currentSortDirection === 'asc' ? 'sortable sort-asc' : 'sortable sort-desc';
                }
                return 'sortable';
            };
            
            let html = `<table class="mapping-table">
                <thead>
                    <tr>
                        <th class="${getSortClass('key')}" onclick="handleSort('key')">Stock Key</th>
                        <th class="${getSortClass('code')}" onclick="handleSort('code')">Stock Code</th>
                        <th class="${getSortClass('description')}" onclick="handleSort('description')">Stock Description</th>
                        <th class="${getSortClass('processFront')}" onclick="handleSort('processFront')">Process Front</th>
                        <th class="${getSortClass('processReverse')}" onclick="handleSort('processReverse')">Process Reverse</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;
            
            keys.forEach(key => {
                const mappingData = mapping[key];
                // Support both old format (string) and new format (object)
                const value = typeof mappingData === 'string' ? mappingData : (mappingData.value || '');
                const processFront = typeof mappingData === 'object' ? (mappingData.processFront || '') : '';
                const processReverse = typeof mappingData === 'object' ? (mappingData.processReverse || '') : '';
                const stockDescription = stockDefinitionsMap[value] || '';
                
                html += `
                    <tr>
                        <td class="key-cell">${escapeHtml(key)}</td>
                        <td class="value-cell">${escapeHtml(value)}</td>
                        <td class="value-cell">${escapeHtml(stockDescription)}</td>
                        <td class="value-cell">${escapeHtml(processFront)}</td>
                        <td class="value-cell">${escapeHtml(processReverse)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editMapping('${escapeHtml(key).replace(/'/g, "\\'")}', '${escapeHtml(value).replace(/'/g, "\\'")}', '${escapeHtml(processFront).replace(/'/g, "\\'")}', '${escapeHtml(processReverse).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMapping('${escapeHtml(key).replace(/'/g, "\\'")}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addMapping() {
            const key = document.getElementById('new-key').value.trim();
            const value = document.getElementById('new-value').value.trim();
            const processFront = document.getElementById('new-process-front').value;
            const processReverse = document.getElementById('new-process-reverse').value;
            
            if (!key || !value) {
                showAlert('mapping-alert', 'Please enter both key and value', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(key)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        value,
                        processFront: processFront || '',
                        processReverse: processReverse || ''
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping added successfully', 'success');
                    document.getElementById('new-key').value = '';
                    document.getElementById('new-value').value = '';
                    document.getElementById('new-process-front').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    document.getElementById('new-process-reverse').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error adding mapping: ' + error.message, 'error');
            }
        }
        
        function editMapping(key, value, processFront, processReverse) {
            // Populate the input fields with existing values
            document.getElementById('new-key').value = key;
            document.getElementById('new-value').value = value;
            document.getElementById('new-process-front').value = processFront || '';
            document.getElementById('new-process-reverse').value = processReverse || '';

            // Scroll to the form
            document.getElementById('new-key').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-key').focus();
            
            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addMapping()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Mapping';
            addButton.onclick = async function() {
                await updateMapping(key);
                addButton.textContent = originalText;
                addButton.onclick = addMapping;
            };
        }
        
        async function updateMapping(oldKey) {
            const newKey = document.getElementById('new-key').value.trim();
            const newValue = document.getElementById('new-value').value.trim();
            const processFront = document.getElementById('new-process-front').value;
            const processReverse = document.getElementById('new-process-reverse').value;
            
            if (!newKey || !newValue) {
                showAlert('mapping-alert', 'Please enter both key and value', 'error');
                return;
            }
            
            try {
                // If the key changed, we need to delete the old one and add the new one
                if (oldKey !== newKey) {
                    // Delete the old mapping
                    const deleteResponse = await fetch(`/api/stock-mapping/${encodeURIComponent(oldKey)}`, {
                        method: 'DELETE'
                    });
                    
                    if (!deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        showAlert('mapping-alert', 'Error deleting old mapping: ' + deleteResult.error, 'error');
                        return;
                    }
                }
                
                // Add/update the new mapping
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(newKey)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        value: newValue,
                        processFront: processFront || '',
                        processReverse: processReverse || ''
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping updated successfully', 'success');
                    document.getElementById('new-key').value = '';
                    document.getElementById('new-value').value = '';
                    document.getElementById('new-process-front').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    document.getElementById('new-process-reverse').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error updating mapping: ' + error.message, 'error');
            }
        }
        
        async function deleteMapping(key) {
            if (!confirm(`Are you sure you want to delete the mapping for "${key}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping deleted successfully', 'success');
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error deleting mapping: ' + error.message, 'error');
            }
        }

        // Stock dropdown functionality
        let allStockDefinitions = [];
        const stockInput = document.getElementById('new-value');
        const stockDropdown = document.getElementById('stock-dropdown');

        async function loadAllStockDefinitions() {
            try {
                const response = await fetch('/api/printiq-stock-definitions');
                allStockDefinitions = await response.json();
                // Don't populate initially, wait for user input
            } catch (error) {
                console.error('Error loading stock definitions:', error);
            }
        }

        function showStockDropdown(stocks) {
            if (stocks.length === 0) {
                stockDropdown.innerHTML = '<div style="padding: 10px; color: #666;">No stock definitions available</div>';
                stockDropdown.style.display = 'block';
                return;
            }

            let html = '';
            stocks.forEach(stock => {
                html += `
                    <div class="stock-option" data-code="${escapeHtml(stock.code)}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="selectStock('${escapeHtml(stock.code).replace(/'/g, "\\'")}')">
                        <div style="font-weight: bold;">${escapeHtml(stock.code)}</div>
                        <div style="font-size: 12px; color: #666;">${escapeHtml(stock.description)}</div>
                    </div>
                `;
            });

            stockDropdown.innerHTML = html;
            stockDropdown.style.display = 'block';
        }

        function filterStockDropdown(query) {
            if (!query) {
                // Show first 20 items when no query
                showStockDropdown(allStockDefinitions.slice(0, 20));
                return;
            }

            const filteredStocks = allStockDefinitions.filter(stock =>
                stock.code.toLowerCase().includes(query.toLowerCase()) ||
                stock.description.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 20); // Limit to 20 results

            if (filteredStocks.length === 0) {
                stockDropdown.innerHTML = '<div style="padding: 10px; color: #666;">No matches found</div>';
                stockDropdown.style.display = 'block';
                return;
            }

            showStockDropdown(filteredStocks);
        }

        function selectStock(code) {
            stockInput.value = code;
            stockDropdown.style.display = 'none';
        }

        // Show dropdown on focus/click
        stockInput.addEventListener('focus', function() {
            filterStockDropdown(this.value);
        });

        stockInput.addEventListener('click', function() {
            filterStockDropdown(this.value);
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!stockInput.contains(e.target) && !stockDropdown.contains(e.target)) {
                stockDropdown.style.display = 'none';
            }
        });

        // Process Types dropdown functionality
        let allProcessTypes = [];
        const processFrontInput = document.getElementById('new-process-front');
        const processFrontDropdown = document.getElementById('process-front-dropdown');
        const processReverseInput = document.getElementById('new-process-reverse');
        const processReverseDropdown = document.getElementById('process-reverse-dropdown');

        async function loadProcessTypesForDropdowns() {
            try {
                const response = await fetch('/api/printiq-process-types');
                allProcessTypes = await response.json();
            } catch (error) {
                console.error('Error loading process types:', error);
            }
        }

        function filterProcessDropdown(type, query) {
            const input = type === 'front' ? processFrontInput : processReverseInput;
            const dropdown = type === 'front' ? processFrontDropdown : processReverseDropdown;

            if (!query) {
                // Show first 20 items when no query
                showProcessDropdown(dropdown, allProcessTypes.slice(0, 20));
                return;
            }

            const filteredTypes = allProcessTypes.filter(pt =>
                pt.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 20); // Limit to 20 results

            if (filteredTypes.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #666;">No matches found</div>';
                dropdown.style.display = 'block';
                return;
            }

            showProcessDropdown(dropdown, filteredTypes);
        }

        function showProcessDropdown(dropdown, processTypes) {
            if (processTypes.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #666;">No process types available</div>';
                dropdown.style.display = 'block';
                return;
            }

            let html = '';
            processTypes.forEach(pt => {
                html += `
                    <div class="process-option" data-value="${escapeHtml(pt)}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="selectProcessType('${escapeHtml(pt).replace(/'/g, "\\'")}', this)">
                        ${escapeHtml(pt)}
                    </div>
                `;
            });

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectProcessType(value, element) {
            // Find the parent dropdown and corresponding input
            const dropdown = element.closest('[id$="-dropdown"]');
            const input = dropdown.id === 'process-front-dropdown' ? processFrontInput : processReverseInput;

            input.value = value;
            dropdown.style.display = 'none';
        }

        // Show dropdown on focus/click for process inputs
        processFrontInput.addEventListener('focus', function() {
            filterProcessDropdown('front', this.value);
        });
        processFrontInput.addEventListener('click', function() {
            filterProcessDropdown('front', this.value);
        });

        processReverseInput.addEventListener('focus', function() {
            filterProcessDropdown('reverse', this.value);
        });
        processReverseInput.addEventListener('click', function() {
            filterProcessDropdown('reverse', this.value);
        });

        // Hide dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!processFrontInput.contains(e.target) && !processFrontDropdown.contains(e.target)) {
                processFrontDropdown.style.display = 'none';
            }
            if (!processReverseInput.contains(e.target) && !processReverseDropdown.contains(e.target)) {
                processReverseDropdown.style.display = 'none';
            }
        });

        async function refreshProcessTypes() {
            const button = document.querySelector('button[onclick="refreshProcessTypes()"]');
            const originalText = button.textContent;
            button.textContent = 'Refreshing...';
            button.disabled = true;

            try {
                const response = await fetch('/api/printiq-process-types/refresh', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('mapping-alert', result.message, 'success');
                    // Reload process types for dropdowns
                    await loadProcessTypesForDropdowns();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error refreshing process types: ' + error.message, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function refreshStockDefinitions() {
            const button = document.querySelector('button[onclick="refreshStockDefinitions()"]');
            const originalText = button.textContent;
            button.textContent = 'Refreshing...';
            button.disabled = true;

            try {
                const response = await fetch('/api/printiq-stock-definitions/refresh', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('mapping-alert', result.message, 'success');
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error refreshing stock definitions: ' + error.message, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        async function loadLatestLogs() {
            const lines = parseInt(document.getElementById('log-lines').value) || 100;
            const viewer = document.getElementById('log-viewer');
            viewer.innerHTML = '<div class="loading">Loading logs...</div>';
            
            try {
                const response = await fetch(`/api/logs/latest/${lines}`);
                const data = await response.json();
                
                if (data.lines.length === 0) {
                    viewer.innerHTML = '<div class="empty-state">No log entries found</div>';
                    return;
                }
                
                let html = `<div style="margin-bottom: 10px; color: #888;">Showing ${data.showing} of ${data.totalLines} lines from ${data.filename}</div>`;
                
                data.lines.forEach(line => {
                    const level = extractLogLevel(line);
                    html += `<div class="log-line" data-level="${level}">${escapeHtml(line)}</div>`;
                });
                
                viewer.innerHTML = html;
                viewer.scrollTop = viewer.scrollHeight;
            } catch (error) {
                viewer.innerHTML = `<div class="alert alert-error">Error loading logs: ${error.message}</div>`;
            }
        }
        
        function extractLogLevel(line) {
            if (line.includes('[ERROR]')) return 'ERROR';
            if (line.includes('[WARN]')) return 'WARN';
            if (line.includes('[INFO]')) return 'INFO';
            return 'INFO';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Operations management functions
        async function loadOperations() {
            try {
                const response = await fetch('/api/operations');
                const operations = await response.json();
                displayOperations(operations);
            } catch (error) {
                showAlert('operations-alert', 'Error loading operations: ' + error.message, 'error');
            }
        }
        
        function displayOperations(operations) {
            const container = document.getElementById('operations-table-container');
            
            if (!Array.isArray(operations) || operations.length === 0) {
                container.innerHTML = '<div class="empty-state">No operations found. Add one above to get started.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>#</th><th>Operation Name</th><th>Actions</th></tr></thead><tbody>';
            
            operations.forEach((operation, index) => {
                html += `
                    <tr>
                        <td style="width: 50px;">${index + 1}</td>
                        <td class="value-cell">${escapeHtml(operation)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editOperation(${index}, '${escapeHtml(operation).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOperation(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addOperation() {
            const operation = document.getElementById('new-operation').value.trim();
            
            if (!operation) {
                showAlert('operations-alert', 'Please enter an operation name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/operations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ operation })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation added successfully', 'success');
                    document.getElementById('new-operation').value = '';
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error adding operation: ' + error.message, 'error');
            }
        }
        
        function editOperation(index, currentOperation) {
            // Populate the input field with existing value
            document.getElementById('new-operation').value = currentOperation;
            
            // Scroll to the form
            document.getElementById('new-operation').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-operation').focus();
            
            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addOperation()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Operation';
            addButton.onclick = async function() {
                await updateOperation(index);
                addButton.textContent = originalText;
                addButton.onclick = addOperation;
            };
        }
        
        async function updateOperation(index) {
            const operation = document.getElementById('new-operation').value.trim();
            
            if (!operation) {
                showAlert('operations-alert', 'Please enter an operation name', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/operations/${index}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ operation })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation updated successfully', 'success');
                    document.getElementById('new-operation').value = '';
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error updating operation: ' + error.message, 'error');
            }
        }
        
        async function deleteOperation(index) {
            if (!confirm(`Are you sure you want to delete this operation?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operations/${index}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation deleted successfully', 'success');
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error deleting operation: ' + error.message, 'error');
            }
        }
        // Section Operations management functions
        async function loadSectionOperations() {
            try {
                const response = await fetch('/api/section-operations');
                const sectionOperations = await response.json();
                displaySectionOperations(sectionOperations);
            } catch (error) {
                showAlert('section-operations-alert', 'Error loading section operations: ' + error.message, 'error');
            }
        }

        function displaySectionOperations(sectionOperations) {
            const container = document.getElementById('section-operations-table-container');

            if (!Array.isArray(sectionOperations) || sectionOperations.length === 0) {
                container.innerHTML = '<div class="empty-state">No section operations found. Add one above to get started.</div>';
                return;
            }

            let html = '<table class="mapping-table"><thead><tr><th>#</th><th>Operation Name</th><th>Group</th><th>Rule</th><th>Actions</th></tr></thead><tbody>';

            sectionOperations.forEach((operation, index) => {
                // Handle both old format (string) and new format (object)
                const operationName = typeof operation === 'string' ? operation : (operation.OperationName || '');
                const group = typeof operation === 'object' ? (operation.Group || '') : '';
                const rule = typeof operation === 'object' ? (operation.Rule || '') : '';
                
                html += `
                    <tr>
                        <td style="width: 50px;">${index + 1}</td>
                        <td class="value-cell">${escapeHtml(operationName)}</td>
                        <td class="value-cell">${escapeHtml(group)}</td>
                        <td class="value-cell">${escapeHtml(rule)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editSectionOperation(${index}, '${escapeHtml(operationName).replace(/'/g, "\\'")}', '${escapeHtml(group).replace(/'/g, "\\'")}', '${escapeHtml(rule).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteSectionOperation(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function addSectionOperation() {
            const operationName = document.getElementById('new-section-operation').value.trim();
            const group = document.getElementById('new-section-group').value.trim();
            const rule = document.getElementById('new-section-rule').value.trim();

            if (!operationName) {
                showAlert('section-operations-alert', 'Please enter a section operation name', 'error');
                return;
            }

            try {
                const body = { operationName };
                if (group) {
                    body.group = group;
                }
                if (rule) {
                    body.rule = rule;
                }

                const response = await fetch('/api/section-operations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('section-operations-alert', 'Section operation added successfully', 'success');
                    document.getElementById('new-section-operation').value = '';
                    document.getElementById('new-section-group').value = '';
                    document.getElementById('new-section-rule').value = '';
                    loadSectionOperations();
                } else {
                    showAlert('section-operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('section-operations-alert', 'Error adding section operation: ' + error.message, 'error');
            }
        }

        function editSectionOperation(index, currentOperationName, currentGroup, currentRule) {
            // Populate the input fields with existing values
            document.getElementById('new-section-operation').value = currentOperationName || '';
            document.getElementById('new-section-group').value = currentGroup || '';
            document.getElementById('new-section-rule').value = currentRule || '';

            // Scroll to the form
            document.getElementById('new-section-operation').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-section-operation').focus();

            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addSectionOperation()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Section Operation';
            addButton.onclick = async function() {
                await updateSectionOperation(index);
                addButton.textContent = originalText;
                addButton.onclick = addSectionOperation;
            };
        }

        async function updateSectionOperation(index) {
            const operationName = document.getElementById('new-section-operation').value.trim();
            const group = document.getElementById('new-section-group').value.trim();
            const rule = document.getElementById('new-section-rule').value.trim();

            if (!operationName) {
                showAlert('section-operations-alert', 'Please enter a section operation name', 'error');
                return;
            }

            try {
                const body = { operationName };
                if (group) {
                    body.group = group;
                }
                if (rule) {
                    body.rule = rule;
                }

                const response = await fetch(`/api/section-operations/${index}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('section-operations-alert', 'Section operation updated successfully', 'success');
                    document.getElementById('new-section-operation').value = '';
                    document.getElementById('new-section-group').value = '';
                    document.getElementById('new-section-rule').value = '';
                    loadSectionOperations();
                } else {
                    showAlert('section-operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('section-operations-alert', 'Error updating section operation: ' + error.message, 'error');
            }
        }

        async function deleteSectionOperation(index) {
            if (!confirm(`Are you sure you want to delete this section operation?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/section-operations/${index}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('section-operations-alert', 'Section operation deleted successfully', 'success');
                    loadSectionOperations();
                } else {
                    showAlert('section-operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('section-operations-alert', 'Error deleting section operation: ' + error.message, 'error');
            }
        }
        // Folders management functions
        async function loadFolders() {
            try {
                const response = await fetch('/api/folders');
                const folders = await response.json();
                displayFolders(folders);
            } catch (error) {
                showAlert('folders-alert', 'Error loading folders: ' + error.message, 'error');
            }
        }
        
        async function loadFolderConfig() {
            try {
                const response = await fetch('/api/folder-config');
                const config = await response.json();
                document.getElementById('current-folder-name').textContent = config.selectedFolderName || config.selectedFolderId || 'Inbox';
            } catch (error) {
                console.error('Error loading folder config:', error);
            }
        }
        
        function displayFolders(folders) {
            const container = document.getElementById('folders-table-container');
            
            if (!Array.isArray(folders) || folders.length === 0) {
                container.innerHTML = '<div class="empty-state">No folders found. Make sure EMAIL_FROM is configured correctly.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>Folder Name</th><th>Unread</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
            
            folders.forEach(folder => {
                html += `
                    <tr>
                        <td class="key-cell">${escapeHtml(folder.name)}</td>
                        <td style="text-align: center;">${folder.unreadItemCount}</td>
                        <td style="text-align: center;">${folder.totalItemCount}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="selectFolder('${escapeHtml(folder.id).replace(/'/g, "\\'")}', '${escapeHtml(folder.name).replace(/'/g, "\\'")}')">Select</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function selectFolder(folderId, folderName) {
            if (!confirm(`Are you sure you want to process emails from "${folderName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/folder-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selectedFolderId: folderId,
                        selectedFolderName: folderName
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('folders-alert', `Folder "${folderName}" selected successfully. Restart the worker service manually.`, 'success');
                    loadFolderConfig();
                } else {
                    showAlert('folders-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('folders-alert', 'Error selecting folder: ' + error.message, 'error');
            }
        }
        
        // Settings management functions
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                document.getElementById('default-stock-code').value = settings.defaultStockCode || '';
                document.getElementById('default-process-front').value = settings.defaultProcessFront || '';
                document.getElementById('default-process-reverse').value = settings.defaultProcessReverse || '';
            } catch (error) {
                showAlert('settings-alert', 'Error loading settings: ' + error.message, 'error');
            }
        }

        async function saveSettings() {
            const defaultStockCode = document.getElementById('default-stock-code').value.trim();
            const defaultProcessFront = document.getElementById('default-process-front').value.trim();
            const defaultProcessReverse = document.getElementById('default-process-reverse').value.trim();

            if (!defaultStockCode || !defaultProcessFront || !defaultProcessReverse) {
                showAlert('settings-alert', 'Please fill in all default settings', 'error');
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        defaultStockCode,
                        defaultProcessFront,
                        defaultProcessReverse
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('settings-alert', 'Settings saved successfully', 'success');
                } else {
                    showAlert('settings-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('settings-alert', 'Error saving settings: ' + error.message, 'error');
            }
        }

        // Default stock dropdown functionality
        let defaultAllStockDefinitions = [];
        const defaultStockInput = document.getElementById('default-stock-code');
        const defaultStockDropdown = document.getElementById('default-stock-dropdown');

        async function loadDefaultStockDefinitions() {
            try {
                const response = await fetch('/api/printiq-stock-definitions');
                defaultAllStockDefinitions = await response.json();
            } catch (error) {
                console.error('Error loading default stock definitions:', error);
            }
        }

        function showDefaultStockDropdown(stocks) {
            if (stocks.length === 0) {
                defaultStockDropdown.innerHTML = '<div style="padding: 10px; color: #666;">No stock definitions available</div>';
                defaultStockDropdown.style.display = 'block';
                return;
            }

            let html = '';
            stocks.forEach(stock => {
                html += `
                    <div class="stock-option" data-code="${escapeHtml(stock.code)}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="selectDefaultStock('${escapeHtml(stock.code).replace(/'/g, "\\'")}')">
                        <div style="font-weight: bold;">${escapeHtml(stock.code)}</div>
                        <div style="font-size: 12px; color: #666;">${escapeHtml(stock.description)}</div>
                    </div>
                `;
            });

            defaultStockDropdown.innerHTML = html;
            defaultStockDropdown.style.display = 'block';
        }

        function filterDefaultStockDropdown(query) {
            if (!query) {
                showDefaultStockDropdown(defaultAllStockDefinitions.slice(0, 20));
                return;
            }

            const filteredStocks = defaultAllStockDefinitions.filter(stock =>
                stock.code.toLowerCase().includes(query.toLowerCase()) ||
                stock.description.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 20);

            if (filteredStocks.length === 0) {
                defaultStockDropdown.innerHTML = '<div style="padding: 10px; color: #666;">No matches found</div>';
                defaultStockDropdown.style.display = 'block';
                return;
            }

            showDefaultStockDropdown(filteredStocks);
        }

        function selectDefaultStock(code) {
            defaultStockInput.value = code;
            defaultStockDropdown.style.display = 'none';
        }

        // Show dropdown on focus/click for default stock
        defaultStockInput.addEventListener('focus', function() {
            filterDefaultStockDropdown(this.value);
        });

        defaultStockInput.addEventListener('click', function() {
            filterDefaultStockDropdown(this.value);
        });

        // Hide dropdown when clicking outside for default stock
        document.addEventListener('click', function(e) {
            if (!defaultStockInput.contains(e.target) && !defaultStockDropdown.contains(e.target)) {
                defaultStockDropdown.style.display = 'none';
            }
        });

        // Default process types dropdown functionality
        let defaultAllProcessTypes = [];
        const defaultProcessFrontInput = document.getElementById('default-process-front');
        const defaultProcessFrontDropdown = document.getElementById('default-process-front-dropdown');
        const defaultProcessReverseInput = document.getElementById('default-process-reverse');
        const defaultProcessReverseDropdown = document.getElementById('default-process-reverse-dropdown');

        async function loadDefaultProcessTypesForDropdowns() {
            try {
                const response = await fetch('/api/printiq-process-types');
                defaultAllProcessTypes = await response.json();
            } catch (error) {
                console.error('Error loading default process types:', error);
            }
        }

        function filterDefaultProcessDropdown(type, query) {
            const input = type === 'front' ? defaultProcessFrontInput : defaultProcessReverseInput;
            const dropdown = type === 'front' ? defaultProcessFrontDropdown : defaultProcessReverseDropdown;

            if (!query) {
                showDefaultProcessDropdown(dropdown, defaultAllProcessTypes.slice(0, 20));
                return;
            }

            const filteredTypes = defaultAllProcessTypes.filter(pt =>
                pt.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 20);

            if (filteredTypes.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #666;">No matches found</div>';
                dropdown.style.display = 'block';
                return;
            }

            showDefaultProcessDropdown(dropdown, filteredTypes);
        }

        function showDefaultProcessDropdown(dropdown, processTypes) {
            if (processTypes.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #666;">No process types available</div>';
                dropdown.style.display = 'block';
                return;
            }

            let html = '';
            processTypes.forEach(pt => {
                html += `
                    <div class="process-option" data-value="${escapeHtml(pt)}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="selectDefaultProcessType('${escapeHtml(pt).replace(/'/g, "\\'")}', this)">
                        ${escapeHtml(pt)}
                    </div>
                `;
            });

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectDefaultProcessType(value, element) {
            const dropdown = element.closest('[id$="-dropdown"]');
            const input = dropdown.id === 'default-process-front-dropdown' ? defaultProcessFrontInput : defaultProcessReverseInput;

            input.value = value;
            dropdown.style.display = 'none';
        }

        // Show dropdown on focus/click for default process inputs
        defaultProcessFrontInput.addEventListener('focus', function() {
            filterDefaultProcessDropdown('front', this.value);
        });
        defaultProcessFrontInput.addEventListener('click', function() {
            filterDefaultProcessDropdown('front', this.value);
        });

        defaultProcessReverseInput.addEventListener('focus', function() {
            filterDefaultProcessDropdown('reverse', this.value);
        });
        defaultProcessReverseInput.addEventListener('click', function() {
            filterDefaultProcessDropdown('reverse', this.value);
        });

        // Hide dropdowns when clicking outside for default process
        document.addEventListener('click', function(e) {
            if (!defaultProcessFrontInput.contains(e.target) && !defaultProcessFrontDropdown.contains(e.target)) {
                defaultProcessFrontDropdown.style.display = 'none';
            }
            if (!defaultProcessReverseInput.contains(e.target) && !defaultProcessReverseDropdown.contains(e.target)) {
                defaultProcessReverseDropdown.style.display = 'none';
            }
        });

        async function refreshDefaultStockDefinitions() {
            const button = document.querySelector('button[onclick="refreshDefaultStockDefinitions()"]');
            const originalText = button.textContent;
            button.textContent = 'Refreshing...';
            button.disabled = true;

            try {
                const response = await fetch('/api/printiq-stock-definitions/refresh', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('settings-alert', result.message, 'success');
                    await loadDefaultStockDefinitions();
                } else {
                    showAlert('settings-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('settings-alert', 'Error refreshing stock definitions: ' + error.message, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function refreshDefaultProcessTypes() {
            const button = document.querySelector('button[onclick="refreshDefaultProcessTypes()"]');
            const originalText = button.textContent;
            button.textContent = 'Refreshing...';
            button.disabled = true;

            try {
                const response = await fetch('/api/printiq-process-types/refresh', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('settings-alert', result.message, 'success');
                    await loadDefaultProcessTypesForDropdowns();
                } else {
                    showAlert('settings-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('settings-alert', 'Error refreshing process types: ' + error.message, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Load mappings on page load
        loadMappings();
        loadProcessTypesForDropdowns();
        loadAllStockDefinitions();

        // Auto-refresh logs every 5 seconds
        setInterval(() => {
            if (document.getElementById('logs-tab').classList.contains('active')) {
                loadLatestLogs();
            }
        }, 5000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Mapping & Logs Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #d0d0d0;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .mapping-table th,
        .mapping-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .mapping-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .mapping-table tr:hover {
            background: #f8f9fa;
        }
        
        .key-cell {
            font-weight: 500;
            color: #2c3e50;
            max-width: 400px;
            word-break: break-word;
        }
        
        .value-cell {
            color: #555;
            max-width: 500px;
            word-break: break-word;
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .log-line {
            margin-bottom: 2px;
        }
        
        .log-line[data-level="ERROR"] {
            color: #f48771;
        }
        
        .log-line[data-level="WARN"] {
            color: #dcdcaa;
        }
        
        .log-line[data-level="INFO"] {
            color: #4ec9b0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Mapping & Logs Manager</h1>
            <div class="subtitle">Manage stock mappings and view application logs</div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('mapping')">Stock Mapping</button>
            <button class="tab" onclick="switchTab('operations')">Operations</button>
            <button class="tab" onclick="switchTab('process-types')">Process Types</button>
            <button class="tab" onclick="switchTab('folders')">Folders</button>
            <button class="tab" onclick="switchTab('logs')">Logs</button>
        </div>
        
        <div id="mapping-tab" class="tab-content active">
            <div id="mapping-alert"></div>
            
            <div class="form-group">
                <label for="new-key">Stock Key (from email):</label>
                <input type="text" id="new-key" placeholder="e.g., 200gsm Synthetic">
            </div>
            
            <div class="form-group">
                <label for="new-value">Stock Code (for PrintIQ):</label>
                <input type="text" id="new-value" placeholder="e.g., Substrate: Yupo FPU250 UV 1320mm c3 200gsm R">
            </div>
            
            <div class="form-group">
                <label for="new-process-front">Process Front:</label>
                <select id="new-process-front" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="new-process-reverse">Process Reverse:</label>
                <select id="new-process-reverse" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="addMapping()">Add Mapping</button>
            <button class="btn btn-success" onclick="loadMappings()" style="margin-left: 10px;">Refresh</button>
            
            <div id="mapping-table-container"></div>
        </div>
        
        <div id="operations-tab" class="tab-content">
            <div id="operations-alert"></div>
            
            <div class="form-group">
                <label for="new-operation">Operation Name:</label>
                <input type="text" id="new-operation" placeholder="e.g., Preflight">
            </div>
            
            <button class="btn btn-primary" onclick="addOperation()">Add Operation</button>
            <button class="btn btn-success" onclick="loadOperations()" style="margin-left: 10px;">Refresh</button>
            
            <div id="operations-table-container"></div>
        </div>
        
        <div id="process-types-tab" class="tab-content">
            <div id="process-types-alert"></div>
            
            <div class="form-group">
                <label for="new-process-type">Process Type Name:</label>
                <input type="text" id="new-process-type" placeholder="e.g., CMYK (Toner) Single Sided">
            </div>
            
            <button class="btn btn-primary" onclick="addProcessType()">Add Process Type</button>
            <button class="btn btn-success" onclick="loadProcessTypes()" style="margin-left: 10px;">Refresh</button>
            
            <div id="process-types-table-container"></div>
        </div>

        <div id="folders-tab" class="tab-content">
            <div id="folders-alert"></div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Select Email Folder</h3>
                <p style="color: #666; margin-bottom: 15px;">Choose the folder from which emails will be processed. The worker will automatically restart and begin polling this folder for unread emails.</p>
                <div id="selected-folder-info" style="padding: 10px; background: #e8f4f8; border-radius: 4px; margin-bottom: 15px;">
                    <strong>Currently selected:</strong> <span id="current-folder-name">Loading...</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="loadFolders()">Refresh Folders</button>
            <button class="btn btn-success" onclick="loadFolderConfig()" style="margin-left: 10px;">Load Current Selection</button>

            <div id="folders-table-container" style="margin-top: 20px;"></div>
        </div>

        <div id="logs-tab" class="tab-content">
            <div class="log-controls">
                <button class="btn btn-primary" onclick="loadLatestLogs()">Refresh Logs</button>
                <label style="margin-left: 20px;">
                    Lines to show:
                    <input type="number" id="log-lines" value="100" min="10" max="1000" style="width: 80px; padding: 5px; margin-left: 5px;">
                </label>
            </div>
            <div id="log-viewer" class="log-viewer">
                <div class="loading">Loading logs...</div>
            </div>
        </div>
    </div>
    
    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'mapping') {
                loadMappings();
                loadProcessTypesForDropdowns();
            } else if (tabName === 'operations') {
                loadOperations();
            } else if (tabName === 'process-types') {
                loadProcessTypes();
            } else if (tabName === 'folders') {
                loadFolders();
                loadFolderConfig();
            } else if (tabName === 'logs') {
                loadLatestLogs();
            }
        }
        
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        async function loadMappings() {
            try {
                const response = await fetch('/api/stock-mapping');
                const mapping = await response.json();
                displayMappings(mapping);
            } catch (error) {
                showAlert('mapping-alert', 'Error loading mappings: ' + error.message, 'error');
            }
        }
        
        function displayMappings(mapping) {
            const container = document.getElementById('mapping-table-container');
            const keys = Object.keys(mapping);
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-state">No stock mappings found. Add one above to get started.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>Stock Key</th><th>Stock Code</th><th>Process Front</th><th>Process Reverse</th><th>Actions</th></tr></thead><tbody>';
            
            keys.forEach(key => {
                const mappingData = mapping[key];
                // Support both old format (string) and new format (object)
                const value = typeof mappingData === 'string' ? mappingData : (mappingData.value || '');
                const processFront = typeof mappingData === 'object' ? (mappingData.processFront || 'None') : 'None';
                const processReverse = typeof mappingData === 'object' ? (mappingData.processReverse || 'None') : 'None';
                
                html += `
                    <tr>
                        <td class="key-cell">${escapeHtml(key)}</td>
                        <td class="value-cell">${escapeHtml(value)}</td>
                        <td class="value-cell">${escapeHtml(processFront)}</td>
                        <td class="value-cell">${escapeHtml(processReverse)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editMapping('${escapeHtml(key).replace(/'/g, "\\'")}', '${escapeHtml(value).replace(/'/g, "\\'")}', '${escapeHtml(processFront).replace(/'/g, "\\'")}', '${escapeHtml(processReverse).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMapping('${escapeHtml(key).replace(/'/g, "\\'")}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addMapping() {
            const key = document.getElementById('new-key').value.trim();
            const value = document.getElementById('new-value').value.trim();
            const processFront = document.getElementById('new-process-front').value;
            const processReverse = document.getElementById('new-process-reverse').value;
            
            if (!key || !value) {
                showAlert('mapping-alert', 'Please enter both key and value', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(key)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        value,
                        processFront: processFront || 'Standard/Heavy CMYK (160sqm/hr)',
                        processReverse: processReverse || 'Standard/Heavy CMYK (160sqm/hr)'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping added successfully', 'success');
                    document.getElementById('new-key').value = '';
                    document.getElementById('new-value').value = '';
                    document.getElementById('new-process-front').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    document.getElementById('new-process-reverse').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error adding mapping: ' + error.message, 'error');
            }
        }
        
        function editMapping(key, value, processFront, processReverse) {
            // Populate the input fields with existing values
            document.getElementById('new-key').value = key;
            document.getElementById('new-value').value = value;
            document.getElementById('new-process-front').value = processFront || 'Standard/Heavy CMYK (160sqm/hr)';
            document.getElementById('new-process-reverse').value = processReverse || 'Standard/Heavy CMYK (160sqm/hr)';
            
            // Scroll to the form
            document.getElementById('new-key').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-key').focus();
            
            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addMapping()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Mapping';
            addButton.onclick = async function() {
                await updateMapping(key);
                addButton.textContent = originalText;
                addButton.onclick = addMapping;
            };
        }
        
        async function updateMapping(oldKey) {
            const newKey = document.getElementById('new-key').value.trim();
            const newValue = document.getElementById('new-value').value.trim();
            const processFront = document.getElementById('new-process-front').value;
            const processReverse = document.getElementById('new-process-reverse').value;
            
            if (!newKey || !newValue) {
                showAlert('mapping-alert', 'Please enter both key and value', 'error');
                return;
            }
            
            try {
                // If the key changed, we need to delete the old one and add the new one
                if (oldKey !== newKey) {
                    // Delete the old mapping
                    const deleteResponse = await fetch(`/api/stock-mapping/${encodeURIComponent(oldKey)}`, {
                        method: 'DELETE'
                    });
                    
                    if (!deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        showAlert('mapping-alert', 'Error deleting old mapping: ' + deleteResult.error, 'error');
                        return;
                    }
                }
                
                // Add/update the new mapping
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(newKey)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        value: newValue,
                        processFront: processFront || 'Standard/Heavy CMYK (160sqm/hr)',
                        processReverse: processReverse || 'Standard/Heavy CMYK (160sqm/hr)'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping updated successfully', 'success');
                    document.getElementById('new-key').value = '';
                    document.getElementById('new-value').value = '';
                    document.getElementById('new-process-front').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    document.getElementById('new-process-reverse').value = 'Standard/Heavy CMYK (160sqm/hr)';
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error updating mapping: ' + error.message, 'error');
            }
        }
        
        async function deleteMapping(key) {
            if (!confirm(`Are you sure you want to delete the mapping for "${key}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/stock-mapping/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('mapping-alert', 'Mapping deleted successfully', 'success');
                    loadMappings();
                } else {
                    showAlert('mapping-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('mapping-alert', 'Error deleting mapping: ' + error.message, 'error');
            }
        }
        
        async function loadLatestLogs() {
            const lines = parseInt(document.getElementById('log-lines').value) || 100;
            const viewer = document.getElementById('log-viewer');
            viewer.innerHTML = '<div class="loading">Loading logs...</div>';
            
            try {
                const response = await fetch(`/api/logs/latest/${lines}`);
                const data = await response.json();
                
                if (data.lines.length === 0) {
                    viewer.innerHTML = '<div class="empty-state">No log entries found</div>';
                    return;
                }
                
                let html = `<div style="margin-bottom: 10px; color: #888;">Showing ${data.showing} of ${data.totalLines} lines from ${data.filename}</div>`;
                
                data.lines.forEach(line => {
                    const level = extractLogLevel(line);
                    html += `<div class="log-line" data-level="${level}">${escapeHtml(line)}</div>`;
                });
                
                viewer.innerHTML = html;
                viewer.scrollTop = viewer.scrollHeight;
            } catch (error) {
                viewer.innerHTML = `<div class="alert alert-error">Error loading logs: ${error.message}</div>`;
            }
        }
        
        function extractLogLevel(line) {
            if (line.includes('[ERROR]')) return 'ERROR';
            if (line.includes('[WARN]')) return 'WARN';
            if (line.includes('[INFO]')) return 'INFO';
            return 'INFO';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Operations management functions
        async function loadOperations() {
            try {
                const response = await fetch('/api/operations');
                const operations = await response.json();
                displayOperations(operations);
            } catch (error) {
                showAlert('operations-alert', 'Error loading operations: ' + error.message, 'error');
            }
        }
        
        function displayOperations(operations) {
            const container = document.getElementById('operations-table-container');
            
            if (!Array.isArray(operations) || operations.length === 0) {
                container.innerHTML = '<div class="empty-state">No operations found. Add one above to get started.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>#</th><th>Operation Name</th><th>Actions</th></tr></thead><tbody>';
            
            operations.forEach((operation, index) => {
                html += `
                    <tr>
                        <td style="width: 50px;">${index + 1}</td>
                        <td class="value-cell">${escapeHtml(operation)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editOperation(${index}, '${escapeHtml(operation).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOperation(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addOperation() {
            const operation = document.getElementById('new-operation').value.trim();
            
            if (!operation) {
                showAlert('operations-alert', 'Please enter an operation name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/operations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ operation })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation added successfully', 'success');
                    document.getElementById('new-operation').value = '';
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error adding operation: ' + error.message, 'error');
            }
        }
        
        function editOperation(index, currentOperation) {
            // Populate the input field with existing value
            document.getElementById('new-operation').value = currentOperation;
            
            // Scroll to the form
            document.getElementById('new-operation').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-operation').focus();
            
            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addOperation()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Operation';
            addButton.onclick = async function() {
                await updateOperation(index);
                addButton.textContent = originalText;
                addButton.onclick = addOperation;
            };
        }
        
        async function updateOperation(index) {
            const operation = document.getElementById('new-operation').value.trim();
            
            if (!operation) {
                showAlert('operations-alert', 'Please enter an operation name', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/operations/${index}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ operation })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation updated successfully', 'success');
                    document.getElementById('new-operation').value = '';
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error updating operation: ' + error.message, 'error');
            }
        }
        
        async function deleteOperation(index) {
            if (!confirm(`Are you sure you want to delete this operation?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operations/${index}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('operations-alert', 'Operation deleted successfully', 'success');
                    loadOperations();
                } else {
                    showAlert('operations-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('operations-alert', 'Error deleting operation: ' + error.message, 'error');
            }
        }
        
        // Process Types management functions
        async function loadProcessTypes() {
            try {
                const response = await fetch('/api/process-types');
                const processTypes = await response.json();
                displayProcessTypes(processTypes);
            } catch (error) {
                showAlert('process-types-alert', 'Error loading process types: ' + error.message, 'error');
            }
        }
        
        async function loadProcessTypesForDropdowns() {
            try {
                const response = await fetch('/api/process-types');
                const processTypes = await response.json();
                
                const frontSelect = document.getElementById('new-process-front');
                const reverseSelect = document.getElementById('new-process-reverse');
                
                // Clear existing options
                frontSelect.innerHTML = '';
                reverseSelect.innerHTML = '';
                
                // Add options
                processTypes.forEach(pt => {
                    const option = document.createElement('option');
                    option.value = pt;
                    option.textContent = pt;
                    frontSelect.appendChild(option.cloneNode(true));
                    reverseSelect.appendChild(option);
                });
                
                // Set default value
                const defaultValue = 'Standard/Heavy CMYK (160sqm/hr)';
                if (processTypes.includes(defaultValue)) {
                    frontSelect.value = defaultValue;
                    reverseSelect.value = defaultValue;
                } else if (processTypes.length > 0) {
                    frontSelect.value = processTypes[0];
                    reverseSelect.value = processTypes[0];
                }
            } catch (error) {
                console.error('Error loading process types for dropdowns:', error);
            }
        }
        
        function displayProcessTypes(processTypes) {
            const container = document.getElementById('process-types-table-container');
            
            if (!Array.isArray(processTypes) || processTypes.length === 0) {
                container.innerHTML = '<div class="empty-state">No process types found. Add one above to get started.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>#</th><th>Process Type Name</th><th>Actions</th></tr></thead><tbody>';
            
            processTypes.forEach((processType, index) => {
                html += `
                    <tr>
                        <td style="width: 50px;">${index + 1}</td>
                        <td class="value-cell">${escapeHtml(processType)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="editProcessType(${index}, '${escapeHtml(processType).replace(/'/g, "\\'")}')" style="margin-right: 5px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProcessType(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addProcessType() {
            const processType = document.getElementById('new-process-type').value.trim();
            
            if (!processType) {
                showAlert('process-types-alert', 'Please enter a process type name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/process-types', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ processType })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('process-types-alert', 'Process type added successfully', 'success');
                    document.getElementById('new-process-type').value = '';
                    loadProcessTypes();
                    loadProcessTypesForDropdowns(); // Refresh dropdowns in mapping tab
                } else {
                    showAlert('process-types-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('process-types-alert', 'Error adding process type: ' + error.message, 'error');
            }
        }
        
        function editProcessType(index, currentProcessType) {
            // Populate the input field with existing value
            document.getElementById('new-process-type').value = currentProcessType;
            
            // Scroll to the form
            document.getElementById('new-process-type').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-process-type').focus();
            
            // Change the button text to indicate we're editing
            const addButton = document.querySelector('button[onclick="addProcessType()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Update Process Type';
            addButton.onclick = async function() {
                await updateProcessType(index);
                addButton.textContent = originalText;
                addButton.onclick = addProcessType;
            };
        }
        
        async function updateProcessType(index) {
            const processType = document.getElementById('new-process-type').value.trim();
            
            if (!processType) {
                showAlert('process-types-alert', 'Please enter a process type name', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/process-types/${index}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ processType })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('process-types-alert', 'Process type updated successfully', 'success');
                    document.getElementById('new-process-type').value = '';
                    loadProcessTypes();
                    loadProcessTypesForDropdowns(); // Refresh dropdowns in mapping tab
                } else {
                    showAlert('process-types-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('process-types-alert', 'Error updating process type: ' + error.message, 'error');
            }
        }
        
        async function deleteProcessType(index) {
            if (!confirm(`Are you sure you want to delete this process type?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/process-types/${index}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('process-types-alert', 'Process type deleted successfully', 'success');
                    loadProcessTypes();
                    loadProcessTypesForDropdowns(); // Refresh dropdowns in mapping tab
                } else {
                    showAlert('process-types-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('process-types-alert', 'Error deleting process type: ' + error.message, 'error');
            }
        }
        
        // Folders management functions
        async function loadFolders() {
            try {
                const response = await fetch('/api/folders');
                const folders = await response.json();
                displayFolders(folders);
            } catch (error) {
                showAlert('folders-alert', 'Error loading folders: ' + error.message, 'error');
            }
        }
        
        async function loadFolderConfig() {
            try {
                const response = await fetch('/api/folder-config');
                const config = await response.json();
                document.getElementById('current-folder-name').textContent = config.selectedFolderName || config.selectedFolderId || 'Inbox';
            } catch (error) {
                console.error('Error loading folder config:', error);
            }
        }
        
        function displayFolders(folders) {
            const container = document.getElementById('folders-table-container');
            
            if (!Array.isArray(folders) || folders.length === 0) {
                container.innerHTML = '<div class="empty-state">No folders found. Make sure EMAIL_FROM is configured correctly.</div>';
                return;
            }
            
            let html = '<table class="mapping-table"><thead><tr><th>Folder Name</th><th>Unread</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
            
            folders.forEach(folder => {
                html += `
                    <tr>
                        <td class="key-cell">${escapeHtml(folder.name)}</td>
                        <td style="text-align: center;">${folder.unreadItemCount}</td>
                        <td style="text-align: center;">${folder.totalItemCount}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="selectFolder('${escapeHtml(folder.id).replace(/'/g, "\\'")}', '${escapeHtml(folder.name).replace(/'/g, "\\'")}')">Select</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function selectFolder(folderId, folderName) {
            if (!confirm(`Are you sure you want to process emails from "${folderName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/folder-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selectedFolderId: folderId,
                        selectedFolderName: folderName
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('folders-alert', `Folder "${folderName}" selected successfully. The worker service is being restarted automatically.`, 'success');
                    loadFolderConfig();
                } else {
                    showAlert('folders-alert', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('folders-alert', 'Error selecting folder: ' + error.message, 'error');
            }
        }
        
        // Load mappings on page load
        loadMappings();
        loadProcessTypesForDropdowns();
        
        // Auto-refresh logs every 5 seconds
        setInterval(() => {
            if (document.getElementById('logs-tab').classList.contains('active')) {
                loadLatestLogs();
            }
        }, 5000);
    </script>
</body>
</html>
